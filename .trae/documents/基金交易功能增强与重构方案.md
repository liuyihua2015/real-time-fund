# 基金收益计算与交易功能重构计划 (Revised v2)

根据您的最新需求（支持按金额/按份额交易、增加手续费计算），我们更新了重构方案。

## 1. 核心指标定义 (Data Model) - 保持不变

| 字段名 | 含义 | 说明 |
| :--- | :--- | :--- |
| `share` | **持有份额** | 当前持有的基金份额数量。买入增加，卖出减少。 |
| `costAmount` | **持仓成本** | 当前持有份额对应的本金总额。 |
| `profitTotal` | **已实现收益** | 历史卖出操作中已经落袋为安的收益总和。 |

---

## 2. 交易逻辑增强 (Enhanced Trade Logic)

我们将创建一个全新的通用交易组件 `TradeModal`，支持以下四种模式：

### A. 买入 (Buy)
1.  **按金额买入 (Buy by Amount)** - *最常用*
    *   输入：`买入金额 (Amount)`, `费率 (Rate)`
    *   计算：
        *   `净申购金额 = Amount / (1 + Rate)`
        *   `手续费 = Amount - 净申购金额`
        *   `确认份额 = 净申购金额 / 确认净值`
    *   更新：
        *   `share += 确认份额`
        *   `costAmount += Amount` (含手续费的投入本金)

2.  **按份额买入 (Buy by Share)** - *补录数据常用*
    *   输入：`确认份额 (Share)`, `费率 (Rate)`
    *   计算：
        *   `净申购金额 = Share * 确认净值`
        *   `总投入金额 = 净申购金额 * (1 + Rate)`
        *   `手续费 = 总投入金额 - 净申购金额`
    *   更新：
        *   `share += Share`
        *   `costAmount += 总投入金额`

### B. 卖出 (Sell)
1.  **按份额卖出 (Sell by Share)** - *最常用*
    *   输入：`卖出份额 (Share)`, `费率 (Rate)`
    *   计算：
        *   `赎回总额 = Share * 确认净值`
        *   `手续费 = 赎回总额 * Rate`
        *   `净赎回金额 (到手) = 赎回总额 - 手续费`
    *   收益计算：
        *   `卖出比例 = Share / 原总份额`
        *   `卖出成本 = 原总成本 * 卖出比例`
        *   `此单收益 = 净赎回金额 - 卖出成本`
    *   更新：
        *   `share -= Share`
        *   `costAmount -= 卖出成本`
        *   `profitTotal += 此单收益`

2.  **按金额卖出 (Sell by Amount)** - *即“我要卖1000块钱”*
    *   输入：`目标到手金额 (Target Amount)`, `费率 (Rate)`
    *   计算：
        *   `赎回总额 = Target Amount / (1 - Rate)` (注：费率通常是扣在总额里的)
        *   `需要卖出份额 = 赎回总额 / 确认净值`
        *   *注：此模式通常用于预估，因为净值未定，但录入历史数据时很有用*
    *   更新：同“按份额卖出”，使用计算出的份额。

---

## 3. UI/UX 规划

### 全新 `TradeModal` 组件
*   **顶栏**：切换 “买入 / 卖出”。
*   **二级导航**：切换 “按金额 / 按份额”。
*   **表单区域**：
    *   `日期`：选择交易确认日期（影响净值获取）。
    *   `金额/份额`：主输入框，根据模式切换。
    *   `费率 (%)`：输入手续费率，默认记忆上次或常用值 (如 0.1%, 0.5%)。
    *   `净值`：自动获取所选日期的净值，允许手动修正。
*   **实时预览**：
    *   根据输入实时计算“预估确认份额”、“预估到手金额”、“预估手续费”。

---

## 4. 执行步骤 (Action Items)

1.  **创建通用组件 `app/components/TradeModal.jsx`**：
    *   实现上述四种模式的表单与计算逻辑。
    *   集成 OCR 功能（保留现有功能并适配新逻辑）。
2.  **重构数据存储层 (`holdingsStorage.js`)**：
    *   确保 `profitTotal` 字段的读写健壮性。
3.  **更新页面集成**：
    *   在 `app/page.jsx` (首页) 和 `app/fund/[code]/FundCardDetailClient.jsx` (详情页) 中，替换旧的 `TradeModalLite` 为新的 `TradeModal`。
    *   更新 `handleTrade` / `applyTrade` 回调函数，处理新的交易数据结构。
4.  **移除冗余代码**：
    *   删除分散在各处的 `TradeModalLite` 定义和文件。

此方案将彻底解决交易记录不灵活、收益计算不准确的问题。
