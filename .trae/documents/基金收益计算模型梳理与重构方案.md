# 基金收益计算模型与优化方案

为了解决当前“计算混乱”的问题，我们重新梳理了基金投资的核心指标定义、计算公式及展示逻辑。

## 1. 核心指标定义 (Data Model)

我们需要明确每个字段在数据库（`localStorage`）中存储的含义：

| 字段名 | 含义 | 说明 |
| :--- | :--- | :--- |
| `share` | **持有份额** | 当前持有的基金份额数量。买入增加，卖出减少。 |
| `costAmount` | **持仓成本** | 当前持有份额对应的本金总额。 |
| `profitTotal` | **已实现收益** | 历史卖出操作中已经落袋为安的收益总和（累计盈亏）。 |

> **关键修正**：之前的代码中 `profitTotal` 有时被用作“总收益”，有时被用作“已实现收益”，导致逻辑混乱。今后统一作为**“已实现收益”**（Realized Profit）。

---

## 2. 计算公式 (Calculation Logic)

基于上述核心指标，前端实时计算以下展示数据：

### A. 基础数据
*   **当前净值/估值 (`currentPrice`)**：
    *   盘中（9:30-15:00）：使用实时估值 (`gsz`)。
    *   盘后/盘前：使用最新确权净值 (`dwjz`)。
*   **当前持仓市值 (`marketValue`)**：
    *   公式：`share * currentPrice`
    *   含义：你现在手里的基金值多少钱。

### B. 收益计算
*   **浮动盈亏 (`floatingProfit`)**：
    *   公式：`marketValue - costAmount`
    *   含义：你当前持有的份额，账面上赚了或亏了多少（未卖出，随行情波动）。
*   **持有收益 / 总收益 (`totalReturn`)**：
    *   公式：`floatingProfit + profitTotal`
    *   含义：**这个基金你一共赚了多少钱**。包含了手里拿着的浮盈，加上以前卖掉赚的钱。
*   **今日收益 (`todayProfit`)**：
    *   公式：`share * (currentPrice - yesterdayNav)`
    *   含义：仅计算**今天一天**因净值波动带来的收益。
*   **昨日收益 (`yesterdayProfit`)**：
    *   公式：`share * (yesterdayNav - dayBeforeYesterdayNav)`
    *   含义：昨天一天确认的收益（通常在晚上更新净值后计算）。

### C. 交易操作对数据的影响
*   **买入 (Buy)**：
    *   `share` = 原份额 + 买入份额
    *   `costAmount` = 原成本 + 买入金额
    *   `profitTotal` 不变
*   **卖出 (Sell)**：
    *   `share` = 原份额 - 卖出份额
    *   卖出比例 = `卖出份额 / 原份额`
    *   卖出成本 = `原成本 * 卖出比例`
    *   此单卖出收益 = `(卖出份额 * 成交净值) - 卖出成本`
    *   `costAmount` = `原成本 - 卖出成本`
    *   `profitTotal` = `原已实现收益 + 此单卖出收益`

---

## 3. 展示层规划 (UI Presentation)

### 首页列表 & 详情页卡片
我们将统一展示以下关键数据，消除歧义：

1.  **持仓金额**：展示 `marketValue`（当前市值）。
    *   *用户疑惑点解答*：这就是“更新后的金额”，包含了本金和浮动盈亏。
2.  **持有收益**：展示 `totalReturn`（总收益）。
    *   公式：`浮动盈亏 + 已实现收益`。
    *   *说明*：这是最核心的指标，代表你玩这个基金总共赚了多少。
3.  **持有收益率**：展示 `totalReturn / costAmount`。
4.  **今日盈亏**：展示 `todayProfit`（仅今日波动）。
5.  **昨日盈亏**：展示 `yesterdayProfit`（仅昨日波动）。

---

## 4. 修改计划 (Action Plan)

1.  **重构存储逻辑 (`holdingsStorage.js`)**：
    *   确保 `profitTotal` 明确定义为“已实现收益”。
    *   在数据迁移时，如果旧数据混淆，默认将其视为“已实现收益”或重置为0。

2.  **重写交易逻辑 (`applyTrade` in `FundCardDetailClient` & `MyHoldingPanel`)**：
    *   **买入**：只更新份额和成本。
    *   **卖出**：**这是关键点**。卖出时必须计算该笔卖出的收益，并累加到 `profitTotal` 中，同时按比例扣减 `costAmount`。
    *   *当前代码缺陷*：目前卖出逻辑只是简单扣减成本，没有计算并累加已实现收益，导致卖出后“总收益”数据丢失。

3.  **统一计算函数 (`getHoldingMetrics`)**：
    *   创建一个共享的计算 Hook 或工具函数，供首页和详情页使用，确保算法一致。
    *   输入：`holding`, `fundDetail`
    *   输出：`marketValue`, `costAmount`, `floatingProfit`, `realizedProfit`, `totalReturn`, `todayProfit`。

4.  **UI 刷新**：
    *   更新首页列表和详情页，使用新的字段名和计算结果。
    *   在编辑弹窗中，明确让用户输入“已实现收益”（如果他们记得的话），或者留空。

确认此方案后，我将开始代码重构。
